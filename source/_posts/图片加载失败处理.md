---
title: 图片加载失败处理
date: 2020-01-14 20:23:58
tags:
---

# 图片加载失败处理 , 加载指定图片或默认图片

当一项资源（如[`<img>`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img)或[`<script>`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/script)）**加载失败**，加载资源的元素会触发一个[`Event`](https://developer.mozilla.org/zh-CN/docs/Web/API/Event)接口的`error`事件，并执行该元素上的`onerror()`处理函数。这些error事件不会向上冒泡到window

因为 `error` 事件无法冒泡，但是事件传播只有冒泡一种方式么，还有捕获

查规范可知，`error` 事件是可以捕获的，那么就可以实现如下代码



```js
    // 图片加载失败模块
let imageList = {
  default: "2.jpg",
  offline: "base64图片地址"
};
window.addEventListener("error", function(e) {
  // 获取出错节点
  let { target } = e;
  // 获取出错节点类型 和自定义属性 (自定义属性data-xxx)
  let { tagName, dataset } = target;
  // 获取自定义属性 time(计数器) ,没有则默认为0
  // 当完全断网的时候，必然什么图片都无法加载，必然导致错误处理被无限触发，可以标记一个计数器，当达到期望的数值时停止继续请求，改为提供一个 Base64 的图片路径
  // data-placehoder 指定图片加载失败之后加载哪张图片
  let { time = 0, placeholder } = dataset;
  // 如果出错节点类型是img就修改src
  if (tagName === "IMG") {
    if (time < 3) {
      // 设置了placeholder 则加载指定图片, 否则加载默认图片
      target.scr = imageList[placeholder || "default"];
      // 加载失败次数+1
      dataset.time = time + 1; 
    } else {
      // 超过3次, 加载offline指定的base64图片
      target.src = imageList["offline"];
    }
  }
},true);
```

